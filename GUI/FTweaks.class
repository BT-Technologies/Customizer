' Gambas class file


PUBLIC SUB Form_Open()
  DIM sZone, Frame, WorkDir, tmpStr, tmpFile AS String
  DIM tz_array AS String[]
  
  Check.Conf_File()
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  
  ME.Center
  ME.Caption = "Tweaks"
  
  FOR EACH sZone IN Dir(WorkDir & "/FileSystem/usr/share/zoneinfo/", "*", gb.Directory).Sort()
    Zone.Add(sZone)
  NEXT
  
  tz_array = Split(File.Load(WorkDir & "/FileSystem/etc/timezone"), "/")
  Zone.Text = tz_array[0]
  
  FOR EACH sZone IN Dir(WorkDir & "/FileSystem/usr/share/zoneinfo/" & Zone.Text, "*").Sort()
    Time.Add(sZone)
  NEXT
  Time.Text = tz_array[1]

  IF Exist(WorkDir & "/FileSystem/etc/apt/apt.conf") THEN
    APT_Recommends.Value = FALSE
  ELSE 
    APT_Recommends.Value = TRUE
  ENDIF 
  
  IF Exist(WorkDir & "/FileSystem/usr/share/initramfs-tools/conf-hooks.d/casper") THEN 
    tmpFile = WorkDir & "/FileSystem/usr/share/initramfs-tools/conf-hooks.d/casper"
    tmpStr = "FRAMEBUFFER="
    Frame = Functions.Get_Str(tmpFile, tmpStr)
  
    IF Frame = "y" THEN 
      Framebuffer.Value = TRUE
    ELSE 
      Framebuffer.Value = FALSE
    ENDIF 
  ELSE 
    Message.Warning("The casper hook file doesn't exist! You will\nnot be able to choose wheter to use or not framebuffer.")
    Framebuffer.Enabled = FALSE
  ENDIF 
  
  tmpFile = WorkDir & "/FileSystem/etc/default/console-setup"
  tmpStr = "ACTIVE_CONSOLES="
  TTYs.Text = Replace$(Replace$(Functions.Get_Str(tmpFile, tmpStr), "/dev/tty[1-", ""), "]", "")
  
  IF Exist(WorkDir & "/FileSystem/bin/ash") THEN 
    SShell.Add("/bin/ash")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/sh") THEN 
    SShell.Add("/bin/sh")
  ENDIF 
  
  IF Exist(WorkDir & "/FileSystem/bin/csh") THEN 
    SShell.Add("/bin/csh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/ksh") THEN 
    SShell.Add("/bin/ksh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/mksh") THEN 
    SShell.Add("/bin/mksh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/tcsh") THEN 
    SShell.Add("/bin/tcsh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/bash") THEN 
    SShell.Add("/bin/bash")
  ENDIF 
  
  IF Exist(WorkDir & "/FileSystem/bin/dash") THEN 
    SShell.Add("/bin/dash")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/psh") THEN 
    SShell.Add("/bin/psh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/zsh") THEN 
    SShell.Add("/bin/zsh")
  ENDIF
  
  IF Exist(WorkDir & "/FileSystem/bin/yash") THEN 
    SShell.Add("/bin/yash")
  ENDIF
  
  tmpFile = WorkDir & "/FileSystem/etc/adduser.conf"
  tmpStr = "DSHELL="
  SShell.Text = Functions.Get_Str(tmpFile, tmpStr)
  
  TRY Zone.Text = File.Load(WorkDir & "/FileSystem/etc/Zone")
END

PUBLIC SUB APT_Recommends_Click()
  DIM WorkDir AS String
  DIM tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  
  IF APT_Recommends.Value = TRUE THEN
    TRY KILL WorkDir & "/FileSystem/etc/apt/apt.conf"
  ELSE 
    TRY File.Save(WorkDir & "/FileSystem/etc/apt/apt.conf", "APT::Install-Recommends \"false\";\nAPT::Install-Suggests \"false\";")
  ENDIF 
END


PUBLIC SUB Time_Click()
  DIM WorkDir AS String
  DIM tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  TRY File.Save(WorkDir & "/FileSystem/etc/timezone", Zone.Text & "/" & Time.Text)
END


PUBLIC SUB Framebuffer_Click()
  DIM WorkDir AS String
  DIM tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  
  IF Framebuffer.Value = TRUE THEN 
    SHELL "sed -i 's/FRAMEBUFFER=.*/FRAMEBUFFER=y/' '" & WorkDir & "/FileSystem/usr/share/initramfs-tools/conf-hooks.d/casper'"
  ELSE 
    SHELL "sed -i 's/FRAMEBUFFER=.*/FRAMEBUFFER=n/' '" & WorkDir & "/FileSystem/usr/share/initramfs-tools/conf-hooks.d/casper'"
  ENDIF 
END

PUBLIC SUB Quit_Click()
  ME.Close
END

PUBLIC SUB TTYs_Click()
  DIM ReplaceString AS String
  DIM WorkDir AS String
  DIM tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
   
  ReplaceString = "\"\\/dev\\/tty[1-" & TTYs.Text & "]\""
  SHELL "sed -i 's/ACTIVE_CONSOLES=.*/ACTIVE_CONSOLES=" & ReplaceString & "/' '" & WorkDir & "/FileSystem/etc/default/console-setup'"
END

PUBLIC SUB SShell_Click()
  DIM ReplaceString, WorkDir, tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  
  SELECT CASE SShell.Text
    CASE "/bin/ash"
      ReplaceString = "\\/bin\\/ash"
    CASE "/bin/sh"
      ReplaceString = "\\/bin\\/sh"
    CASE "/bin/csh"
      ReplaceString = "\\/bin\\/csh"
    CASE "/bin/ksh"
      ReplaceString = "\\/bin\\/ksh"
    CASE "/bin/mksh"
      ReplaceString = "\\/bin\\/mksh"
    CASE "/bin/tcsh"
      ReplaceString = "\\/bin\\/tcsh"
    CASE "/bin/bash"
      ReplaceString = "\\/bin\\/bash"
    CASE "/bin/dash"
      ReplaceString = "\\/bin\\/dash"
    CASE "/bin/psh"
      ReplaceString = "\\/bin\\/psh"
    CASE "/bin/zsh"
      ReplaceString = "\\/bin\\/zsh"
    CASE "/bin/yash"
      ReplaceString = "\\/bin\\/yash"
  END SELECT 

  SHELL "sed -i 's/DSHELL=.*/DSHELL=" & ReplaceString & "/' '" & WorkDir & "/FileSystem/etc/adduser.conf'"
END

PUBLIC SUB Zone_Click()
  DIM sZone, WorkDir, tmpStr AS String
  
  tmpStr = "WORK_DIR="
  WorkDir = Functions.Get_Conf(tmpStr)
  
  Time.Clear
  FOR EACH sZone IN Dir(WorkDir & "/FileSystem/usr/share/zoneinfo/" & Zone.Text, "*").Sort()
    Time.Add(sZone)
  NEXT
END
